name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    env:
      MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
      MODRINTH_PROJECT_ID: ${{ secrets.MODRINTH_PROJECT_ID }}
      CURSEFORGE_TOKEN: ${{ secrets.CURSEFORGE_TOKEN }}
      CURSEFORGE_PROJECT_ID: ${{ secrets.CURSEFORGE_PROJECT_ID }}
      STRUTTURA_BEARER_TOKEN: ${{ secrets.STRUTTURA_BEARER_TOKEN }}
      LOADER_VERSION: "0.18.2"
      MC_VERSION: "1.21.11"
    steps:

      # --- Build ---
      - uses: actions/checkout@v4
      - uses: gradle/actions/wrapper-validation@v4
      - uses: actions/setup-java@v4
        with:
          distribution: microsoft
          java-version: 21
      - run: chmod +x ./gradlew
      - run: ./gradlew build

      # --- Extract version from tag ---
      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      # --- Find mod JAR ---
      - name: Find mod JAR
        id: jar
        run: |
          JAR=$(find build/libs -name "struttura-*.jar" ! -name "*-sources.jar" ! -name "*-dev.jar" | head -1)
          echo "path=$JAR" >> "$GITHUB_OUTPUT"
          echo "name=$(basename $JAR)" >> "$GITHUB_OUTPUT"

      # --- GitHub Release (always) ---
      - name: Delete existing release (if re-tagging)
        run: gh release delete "${GITHUB_REF_NAME}" --yes 2>/dev/null || true
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.jar.outputs.path }}
          generate_release_notes: true

      # --- Fetch changelog from GitHub Release ---
      - name: Fetch changelog
        id: changelog
        run: echo "body<<GHEOF" >> "$GITHUB_OUTPUT" && gh release view "${GITHUB_REF_NAME}" --json body -q .body >> "$GITHUB_OUTPUT" && echo "GHEOF" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}

      # --- Modrinth (optional: skipped if MODRINTH_TOKEN or MODRINTH_PROJECT_ID is missing) ---
      - name: Delete existing Modrinth version (if re-tagging)
        if: env.MODRINTH_TOKEN != '' && env.MODRINTH_PROJECT_ID != ''
        run: |
          VERSION_ID=$(curl -s -H "Authorization: $MODRINTH_TOKEN" \
            "https://api.modrinth.com/v2/project/$MODRINTH_PROJECT_ID/version" \
            | jq -r --arg v "${{ steps.version.outputs.version }}" '.[] | select(.version_number == $v) | .id' | head -1)
          if [ -n "$VERSION_ID" ] && [ "$VERSION_ID" != "null" ]; then
            echo "Deleting existing Modrinth version $VERSION_ID"
            curl -sf -X DELETE -H "Authorization: $MODRINTH_TOKEN" \
              "https://api.modrinth.com/v2/version/$VERSION_ID"
          else
            echo "No existing version found, proceeding"
          fi

      - name: Publish to Modrinth
        if: env.MODRINTH_TOKEN != '' && env.MODRINTH_PROJECT_ID != ''
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: ${{ env.MODRINTH_PROJECT_ID }}
          modrinth-token: ${{ env.MODRINTH_TOKEN }}
          files: ${{ steps.jar.outputs.path }}
          name: Struttura ${{ steps.version.outputs.version }}
          version: ${{ steps.version.outputs.version }}
          version-type: alpha
          loaders: fabric
          game-versions: 1.21.11
          changelog: ${{ steps.changelog.outputs.body }}
          dependencies: |
            fabric-api | depends

      # --- CurseForge (optional: skipped if CURSEFORGE_TOKEN or CURSEFORGE_PROJECT_ID is missing) ---
      - name: Publish to CurseForge
        if: env.CURSEFORGE_TOKEN != '' && env.CURSEFORGE_PROJECT_ID != ''
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          curseforge-id: ${{ env.CURSEFORGE_PROJECT_ID }}
          curseforge-token: ${{ env.CURSEFORGE_TOKEN }}
          files: ${{ steps.jar.outputs.path }}
          name: Struttura ${{ steps.version.outputs.version }}
          version: ${{ steps.version.outputs.version }}
          version-type: alpha
          loaders: fabric
          game-versions: 1.21.11
          changelog: ${{ steps.changelog.outputs.body }}
          dependencies: |
            fabric-api | depends

      # --- Struttura website (optional: upload JAR via REST API) ---
      # API: POST /struttura/v1/mod/releases (Bearer auth)
      # Body: loader_version, minecraft_version, mod_version, jar_filename, jar_data (base64), changelog
      - name: Upload release to Struttura website
        if: env.STRUTTURA_BEARER_TOKEN != ''
        run: |
          JAR_BASE64=$(base64 -w 0 "${{ steps.jar.outputs.path }}")
          CHANGELOG=$(gh release view "${GITHUB_REF_NAME}" --json body -q .body 2>/dev/null || echo "Release ${GITHUB_REF_NAME}")
          curl -sf -X POST https://api-struttura.magius.it/v1/mod/releases \
            -H "Authorization: Bearer $STRUTTURA_BEARER_TOKEN" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "loader_version": "fabric-${{ env.LOADER_VERSION }}",
            "minecraft_version": "${{ env.MC_VERSION }}",
            "mod_version": "${{ steps.version.outputs.version }}",
            "jar_filename": "${{ steps.jar.outputs.name }}",
            "jar_data": "${JAR_BASE64}",
            "changelog": $(echo "$CHANGELOG" | jq -Rs .),
            "disable_announcement": true
          }
          EOF
        env:
          GH_TOKEN: ${{ github.token }}
